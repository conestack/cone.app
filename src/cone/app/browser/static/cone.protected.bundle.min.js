var cone=function(e,t){"use strict";class s{constructor(e){}size_binder(e,s){s||(s=".batched_items_slice_size select");let a=t(s,e);a.off("change").on("change",(function(e){let s=t("option:selected",t(this)).first().val();cone.batcheditems_handle_filter(a,"size",s)}))}filter_binder(e,s,a){s||(s=".batched_items_filter input"),a||(a="term");let i=t(s,e),r=function(e){let t=e.attr("value");cone.batcheditems_handle_filter(e,a,t)};i.hasClass("empty_filter")&&i.on("focus",(function(){this.value="",t(this).removeClass("empty_filter")})),i.off("keypress").on("keypress",(function(e){13==e.keyCode&&e.preventDefault()})),i.off("keyup").on("keyup",(function(e){13==e.keyCode&&(e.preventDefault(),r(t(this)))})),i.off("change").on("change",(function(e){e.preventDefault(),r(t(this))}))}items_binder(e,t,s){this.size_binder(e,t),this.filter_binder(e,s)}handle_filter(e,t,s){let a=ts.ajax.parsetarget(e.attr("ajax:target")),i=e.attr("ajax:event");if(a.params[t]=s,e.attr("ajax:path")){let r=e.attr("ajax:path-event");r||(r=i),ts.ajax.path({path:a.path+a.query+"&"+t+"="+s,event:r,target:a})}let r=i.split(":");ts.ajax.trigger(r[0],r[1],a)}}return t((function(e,t){cone.KeyBinder(),t.ajax.register(cone.Settingstabs.bind(cone),!0),t.ajax.register(cone.BatchedItems.bind(cone),!0),t.ajax.register(cone.TableToolBar.bind(cone),!0),t.ajax.register(cone.Sharing.bind(cone),!0),t.ajax.register(cone.CopySupport.bind(cone),!0);var s=yafowil.referencebrowser;t.ajax.register(s.browser_binder.bind(s),!0),t.ajax.register(s.add_reference_binder.bind(s)),t.ajax.register(s.remove_reference_binder.bind(s))})),e.BatchedItems=s,e.CopySupport=class{constructor(e){this.context=e,this.paste_action=t("a#toolbaraction-paste",e),this.paste_action.off("click").on("click",this.handle_paste.bind(this)),this.copyable=t("table tr.selectable.copysupportitem",e),this.copyable.length&&(this.cut_action=t("a#toolbaraction-cut",e),this.cut_action.off("click").on("click",this.handle_cut.bind(this)),this.copy_action=t("a#toolbaraction-copy",e),this.copy_action.off("click").on("click",this.handle_copy.bind(this)),this.selectable=this.copyable.selectable({on_firstclick:this.on_firstclick.bind(this),on_select:this.on_select.bind(this)}).data("selectable"),this.read_selected_from_cookie(this.cut_cookie,"copysupport_cut"),this.read_selected_from_cookie(this.copy_cookie,""))}on_firstclick(e,t){console.log("click")}on_select(e){}write_selected_to_cookie(e){let s=t(this.selectable.selected),a=new Array;s.each((function(){a.push(t(this).attr("ajax:target"))}));let i=a.join("::");createCookie(e,i),i.length?t(this.paste_action).removeClass("disabled"):t(this.paste_action).addClass("disabled")}read_selected_from_cookie(e,s){let a=readCookie(e);if(!a)return;let i,r,n=a.split("::"),c=this;t("table tr.selectable",this.context).each((function(){i=t(this),r=i.attr("ajax:target");for(let e in n)if(n[e]==r){i.addClass("selected"),s&&i.addClass(s),c.selectable.add(i.get(0));break}}))}handle_cut(e){e.preventDefault(),createCookie(this.copy_cookie,"",0),this.write_selected_to_cookie(this.cut_cookie),this.copyable.removeClass("copysupport_cut"),t(this.selectable.selected).addClass("copysupport_cut")}handle_copy(e){e.preventDefault(),createCookie(this.cut_cookie,"",0),this.write_selected_to_cookie(this.copy_cookie),this.copyable.removeClass("copysupport_cut")}handle_paste(e){e.preventDefault();let s=t(e.currentTarget);if(s.hasClass("disabled"))return;let a=ts.ajax.parsetarget(s.attr("ajax:target"));ts.ajax.action({name:"paste",mode:"NONE",selector:"NONE",url:a.url,params:a.params})}},e.KeyBinder=class{constructor(){this._keydown=this.key_down.bind(this),this._keyup=this.key_up.bind(this),t(document).on("keydown",this._keydown),t(document).on("keyup",this._keyup)}key_down(e){switch(e.keyCode||e.which){case 16:cone.keys.shift_down=!0;break;case 17:cone.keys.ctrl_down=!0}}key_up(e){switch(e.keyCode||e.which){case 16:cone.keys.shift_down=!1;break;case 17:cone.keys.ctrl_down=!1}}},e.ReferenceBrowser=class{constructor(e){}overlay(){return t("#ajax-overlay").data("overlay")}browser_binder(e){t(".referencebrowser_trigger",e).referencebrowser()}add_reference_binder(e){t("a.addreference").off("click").on("click",(function(e){e.preventDefault(),yafowil.referencebrowser.addreference(t(this))}))}remove_reference_binder(e){t("a.removereference").off("click").on("click",(function(e){e.preventDefault(),yafowil.referencebrowser.removereference(t(this))}))}addreference(e){let s=t(this.target),a=e.attr("id");a=a.substring(4,a.length);let i=t(".reftitle",e.parent()).html();if(this.singlevalue()){s.attr("value",i);let e='[name="'+s.attr("name")+'.uid"]';return t(e).attr("value",a),this._set_selected_on_ajax_target(s.parent(),[a]),void this.overlay().close()}if(this.multivalue()){if(t('[value="'+a+'"]',s.parent()).length)return;let e=t("<option></option>");e.val(a).html(i).attr("selected","selected"),s.append(e)}this._reset_selected(s),this._toggle_enabled(e)}removereference(e){let s=t(this.target),a=e.attr("id");if(a=a.substring(4,a.length),this.singlevalue()){s.attr("value","");let e='[name="'+s.attr("name")+'.uid"]';t(e).attr("value","")}if(this.multivalue()){let e='[value="'+a+'"]';if(!t(e,s.parent()).length)return;t(e,s).remove()}this._reset_selected(s),this._toggle_enabled(e)}singlevalue(){return"INPUT"==this.target.tagName}multivalue(){return"SELECT"==this.target.tagName}_toggle_enabled(e){t("a",e.parent()).toggleClass("disabled")}_reset_selected(e){let s=new Array;this.singlevalue()&&s.push(e.attr("value")),this.multivalue()&&t("[selected=selected]",e).each((function(){s.push(t(this).attr("value"))})),this._set_selected_on_ajax_target(e.parent(),s);let a,i=this.overlay().getOverlay();t("div.referencebrowser a",i).each((function(){let e=t(this);e.attr("ajax:target")&&(a=yafowil.referencebrowser,a._set_selected_on_ajax_target(e,s))}))}_set_selected_on_ajax_target(e,t){let s=ts.ajax.parsetarget(e.attr("ajax:target"));s.params.selected=t.join(",");let a=new Array;for(let e in s.params)a.push(e+"="+s.params[e]);e.attr("ajax:target",s.url+"?"+a.join("&"))}},e.Selectable=class{constructor(e){this.options=e,this.selected=[],this.select_direction=0,this.firstclick=!0}reset(){this.selected=[]}add(e){this.remove(e),this.selected.push(e)}remove(e){let s=t.grep(this.selected,(function(t,s){return t!==e}));this.selected=s}select_no_key(e,t){e.children().removeClass("selected"),t.addClass("selected"),this.reset(),this.add(t.get(0))}select_ctrl_down(e){e.toggleClass("selected"),e.hasClass("selected")?this.add(e.get(0)):this.remove(e.get(0))}get_nearest(e,s){let a,i,r=e.children(".selected"),n=-1;return t(r).each((function(){i=t(this),a=i.index(),-1==n?n=a:s>a?this.select_direction>0?a<n&&(n=a):a>n&&(n=a):s<a&&a<n&&(n=a)})),n}select_shift_down(e,t){let s=t.index(),a=this.get_nearest(e,s);if(-1==a)t.addClass("selected"),this.add(t.get(0));else{let t,i;e.children().removeClass("selected"),s<a?(this.select_direction=-1,t=s,i=a):(this.select_direction=1,t=a,i=s),this.reset();let r=this;e.children().slice(t,i+1).addClass("selected").each((function(){r.add(this)}))}}handle_click(e){e.preventDefault();let s=t(e.currentTarget),a=s.parent();cone.keys.ctrl_down||cone.keys.shift_down?cone.keys.ctrl_down?this.select_ctrl_down(s):cone.keys.shift_down&&this.select_shift_down(a,s):this.select_no_key(a,s),this.firstclick&&(this.firstclick=!1,this.notify("on_firstclick",this,s)),this.notify("on_select",this)}notify(e,...t){this.options&&this.options[e]&&this.options[e](...t)}bind(e){e.off("click").on("click",this.handle_click.bind(this))}},e.Settingstabs=class{constructor(e){this.elems=t("ul.settingstabs a",e),this._bind=this.bind_settings.bind(this),this.elems.on("click",this._bind)}bind_settings(e){e.preventDefault();let s=t(this),a=ts.ajax.parsetarget(s.attr("ajax:target"));ts.ajax.request({url:a.url,params:a.params,success:function(e,a,i){let r=t(s).parent().parent();t("li",r).removeClass("active"),s.parent().addClass("active"),t(".settingstabpane").html(e).css("display","block").tsajax()}}),this.elems.first().trigger("click")}},e.Sharing=class{constructor(e){}sharingbinder(e){t("input.add_remove_role_for_principal",e).off("change").on("change",(function(e){e.preventDefault();let s,a=t(this);s=this.checked?"add_principal_role":"remove_principal_role";let i=a.parent().attr("ajax:target"),r={id:a.attr("name"),role:a.attr("value")};ts.ajax.action({name:s,mode:"NONE",selector:"NONE",url:i,params:r})}))}},e.TableToolBar=class extends s{constructor(e){}tabletoolbarbinder(e){this.items_binder(e,".table_length select",".table_filter input")}},Object.defineProperty(e,"__esModule",{value:!0}),window.cone=e,e}({},jQuery);
